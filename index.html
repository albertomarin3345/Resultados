<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="style.css" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscar</title>
</head>

<body>
    <section>
        <div class="logar">
            <img style="border-radius: 12px;" src="IMG_0205.jpg" width="150px" height="150px" />
        </div>
    </section>
    <section>
        <h1>Agradecemos tu participación...</h1>
        <div class="log">
            <p>Coloca tu nombre iniciando por apellidos y con mayuscula.</p>
            <p>"Ejemplo: Martínez García Samuel"</p>
        </div>
    </section>
    <section>
        <div class="search-container">
            <h1>Resultados LIMATEJ y STEAM 2025</h1>
            <center>
                <p style="color: blue;"><b>ZONA 6</b></p>
            </center>
            <input type="text" id="studentName" placeholder="Nombre del alumno">
            <button onclick="searchStudent()">Buscar</button>
        </div>

        <div id="results"></div>
    </section>
    <section style="display: flex; justify-content: center; gap: 20px;">
        <img style="border-radius: 12px;" src="Lima.png" width="150px" height="auto" />
        <img style="border-radius: 12px;" src="Steam.png" width="150px" height="auto" />
    </section>
    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxBG8MRexh39kn8Nqsqnrna_Icvs9Rla8BuYf91kBMg08_HfzWZu5KbAHCZlHqEUx9Fxg/exec";

        function getGoogleDriveDownloadLink(url) {
            if (!url) return null;
            if (url.includes("export=download")) return url;
        
            if (url.includes("drive.google.com/file/d/")) {
                const fileId = url.match(/\/file\/d\/([^\/]+)/)?.[1];
                return fileId ? `https://drive.google.com/uc?export=download&id=${fileId}` : url;
            }
        
            return url;
        }

        function searchStudent() {
            const studentName = document.getElementById('studentName').value.trim();
            const resultsDiv = document.getElementById('results');

            if (!studentName) {
                resultsDiv.innerHTML = '<p class="error">Por favor ingresa un nombre de alumno</p>';
                return;
            }

            resultsDiv.innerHTML = '<p>Buscando...</p>';

            fetch(`${SCRIPT_URL}?name=${encodeURIComponent(studentName)}`)
                .then(response => {
                    if (!response.ok) throw new Error("Error en la respuesta del servidor");
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        resultsDiv.innerHTML = `<p class="error">${data.error}</p>`;
                        return;
                    }

                    if (!data.data || data.data.length === 0) {
                        resultsDiv.innerHTML = '<p class="error">No se encontraron alumnos con ese nombre</p>';
                        return;
                    }

                    let html = `<h2>Resultados para "${studentName}"</h2>`;
                    data.data.forEach(student => {
                        const rawUrl = student.constancia?.match(/=HIPERVINCULO\("([^"]+)"/i)?.[1] || student.constancia;
                        const downloadUrl = getGoogleDriveDownloadLink(rawUrl);

                        const pdfLink = downloadUrl
                            ? `<a href="${downloadUrl}" class="pdf-link" target="_blank" download="Constancia_${student.alumno.replace(/\s+/g, '_')}.pdf">Descargar Constancia</a>`
                            : 'N/A';

                        html += `
                            <div class="student-card">
                                <h3>${student.alumno}</h3>
                                <p><strong>Escuela:</strong> ${student.escuela || 'N/A'}</p>
                                <p><strong>Constancia:</strong> ${pdfLink}</p>
                                <p><strong>Puntos:</strong> ${student.puntos || 'N/A'}</p>
                                <p><strong>Status:</strong> ${student.status || 'N/A'}</p>
                            </div>
                        `;
                    });

                    resultsDiv.innerHTML = html;
                })
                .catch(error => {
                    resultsDiv.innerHTML = `<p class="error">Error al buscar datos: ${error.message}</p>`;
                    console.error("Error completo:", error);
                });
        }
    </script>
</body>

</html>